# GPT Researcher 接口文档

## 1. 主要对外接口

### 1.1 GPTResearcher 主类接口

**文件位置**: `gpt_researcher/agent.py`

#### 类初始化接口
```python
class GPTResearcher:
    def __init__(
        self,
        query: str,                              # 研究查询
        report_type: str = "research_report",    # 报告类型
        report_format: str = "markdown",        # 报告格式
        report_source: str = "web",             # 报告来源
        tone: str = "objective",                # 报告语气
        source_urls: list[str] | None = None,   # 指定源 URL
        document_urls: list[str] | None = None, # 文档 URL
        query_domains: list[str] | None = None, # 查询域名限制
        vector_store=None,                      # 向量存储
        config_path=None,                       # 配置文件路径
        websocket=None,                         # WebSocket 连接
        verbose: bool = True,                    # 详细输出
        **kwargs
    )
```

#### 核心方法接口

##### 研究执行接口
- **`async conduct_research(on_progress=None)`**
  - **功能**: 执行主要研究流程
  - **参数**: 
    - `on_progress`: 进度回调函数
  - **返回**: `list` - 研究上下文数据
  - **使用场景**: 需要获取原始研究数据时

- **`async write_report(existing_headers=[], relevant_written_contents=[], ext_context=None, custom_prompt="")`**
  - **功能**: 生成研究报告
  - **参数**:
    - `existing_headers`: 已有的标题列表
    - `relevant_written_contents`: 相关内容
    - `ext_context`: 外部上下文
    - `custom_prompt`: 自定义提示
  - **返回**: `str` - Markdown 格式的完整报告
  - **使用场景**: 生成最终研究报告

##### 快速查询接口
- **`async quick_search(query: str, query_domains: list[str] = None)`**
  - **功能**: 快速搜索，不执行完整研究流程
  - **返回**: `list[Any]` - 搜索结果
  - **使用场景**: 需要快速获取信息时

##### 子主题管理接口
- **`async get_subtopics()`**
  - **功能**: 获取研究子主题
  - **返回**: `list` - 子主题列表

- **`async get_draft_section_titles(current_subtopic: str)`**
  - **功能**: 获取草稿章节标题
  - **返回**: `list[str]` - 章节标题列表

##### 数据获取接口
- **`get_research_sources()`**
  - **功能**: 获取研究来源
  - **返回**: `list[dict]` - 来源信息列表

- **`get_source_urls()`**
  - **功能**: 获取已访问的 URL
  - **返回**: `list` - URL 列表

- **`get_research_context()`**
  - **功能**: 获取研究上下文
  - **返回**: `list` - 上下文数据

- **`get_costs()`**
  - **功能**: 获取研究成本
  - **返回**: `float` - 总成本

### 1.2 FastAPI 服务器接口

**文件位置**: `backend/server/server.py`

#### HTTP 端点

##### GET `/`
- **功能**: 返回主界面
- **返回**: HTML 页面

##### GET `/report/{research_id}`
- **功能**: 下载生成的报告
- **参数**: `research_id` - 研究 ID
- **返回**: DOCX 文件

##### POST `/report/`
- **功能**: 生成研究报告
- **请求体**: `ResearchRequest` 模型
- **返回**: JSON 格式的报告元数据

##### POST `/config`
- **功能**: 更新配置
- **请求体**: `ConfigRequest` 模型
- **返回**: 配置更新结果

##### WebSocket `/ws`
- **功能**: 实时进度更新
- **用途**: 研究过程中的实时通信

#### 请求模型

##### ResearchRequest
```python
class ResearchRequest(BaseModel):
    task: str                    # 研究任务
    report_type: str            # 报告类型
    report_source: str          # 报告来源
    tone: str                   # 报告语气
    headers: dict | None = None # 请求头
    generate_in_background: bool = True  # 后台生成
```

##### ConfigRequest
```python
class ConfigRequest(BaseModel):
    OPENAI_API_KEY: str
    TAVILY_API_KEY: str
    RETRIEVER: str
    # 其他配置项...
```

### 1.3 CLI 接口

**文件位置**: `cli.py`

#### 使用方式
```bash
python cli.py "<query>" [options]
```

#### 参数说明
- **`query`** (必需): 研究查询字符串
- **`--report_type`**: 报告类型
  - `research_report`: 研究报告（默认）
  - `detailed_report`: 详细报告
  - `resource_report`: 资源报告
  - `outline_report`: 大纲报告
  - `custom_report`: 自定义报告
  - `subtopic_report`: 子主题报告
  - `deep_research`: 深度研究

- **`--tone`**: 报告语气
  - `objective`: 客观（默认）
  - `formal`: 正式
  - `analytical`: 分析性
  - `persuasive`: 说服性
  - `informative`: 信息性
  - 其他多种语气选项...

- **`--query_domains`**: 限制搜索域名（逗号分隔）
- **`--encoding`**: 输出文件编码（默认: utf-8）

## 2. 内部技能接口

### 2.1 ResearchConductor 研究指挥器

**文件位置**: `skills/researcher.py`

```python
class ResearchConductor:
    async def conduct_research(self) -> list
    async def plan_research(self, query, query_domains=None) -> list
    async def _get_context_by_web_search(self, query, scraped_data, query_domains) -> list
    async def _get_context_by_urls(self, urls) -> list
    async def _get_context_by_vectorstore(self, query, filter) -> list
```

### 2.2 ReportGenerator 报告生成器

**文件位置**: `skills/writer.py`

```python
class ReportGenerator:
    async def write_report(self, existing_headers=[], relevant_written_contents=[], ext_context=None, custom_prompt="") -> str
    async def write_report_conclusion(self, report_content: str) -> str
    async def write_introduction(self) -> str
    async def get_subtopics(self) -> list
    async def get_draft_section_titles(self, current_subtopic: str) -> list
```

### 2.3 ContextManager 上下文管理器

**文件位置**: `skills/context_manager.py`

```python
class ContextManager:
    async def get_similar_content_by_query(self, query, pages) -> str
    async def get_similar_content_by_query_with_vectorstore(self, query, filter) -> str
    async def get_similar_written_contents_by_draft_section_titles(self, current_subtopic, draft_section_titles, written_contents, max_results=10) -> list[str]
```

### 2.4 BrowserManager 浏览器管理器

**文件位置**: `skills/browser.py`

```python
class BrowserManager:
    async def browse_urls(self, urls: list[str]) -> list[dict]
    def select_top_images(self, images: list[dict], k: int = 2) -> list[str]
```

## 3. 检索器接口

### 3.1 基础检索器接口

所有检索器实现统一接口：

```python
class BaseRetriever:
    def __init__(self, query, headers=None, query_domains=None, **kwargs)
    def search(self, max_results=10) -> list[dict]  # 返回搜索结果
```

### 3.2 可用检索器

#### Web 搜索检索器
- **TavilySearch**: Tavily API 搜索
- **Duckduckgo**: DuckDuckGo 搜索
- **GoogleSearch**: Google 搜索
- **BingSearch**: Bing 搜索
- **SerperSearch**: Serper API 搜索
- **SerpApiSearch**: SerpAPI 搜索
- **SearchApiSearch**: SearchAPI 搜索
- **SearxSearch**: Searx 元搜索
- **ExaSearch**: Exa 神经搜索

#### 学术检索器
- **ArxivSearch**: ArXiv 学术论文
- **SemanticScholarSearch**: Semantic Scholar 学术搜索
- **PubMedCentralSearch**: PubMed 医学文献

#### 高级检索器
- **MCPRetriever**: Model Context Protocol 检索器
  - 支持智能工具选择
  - 多 MCP 服务器集成
  - 可配置执行策略

### 3.3 MCPRetriever 高级接口

```python
class MCPRetriever:
    def __init__(self, query, headers=None, query_domains=None, websocket=None, researcher=None, **kwargs)
    
    def search(self, max_results=10) -> list[dict]
    async def search_async(self, max_results=10) -> list[dict]
```

## 4. 记忆和嵌入接口

### 4.1 Memory 类

**文件位置**: `memory/embeddings.py`

```python
class Memory:
    def __init__(self, embedding_provider: str, model: str, **embedding_kwargs: Any)
    def get_embeddings(self)  # 返回配置的嵌入模型
```

#### 支持的嵌入提供商
- OpenAI, Azure OpenAI, Cohere
- Google VertexAI, Google GenAI
- Fireworks, GigaChat, Ollama
- Together, MistralAI, HuggingFace
- Nomic, VoyageAI, Dashscope
- Bedrock, AIMLAPI 等

### 4.2 VectorStoreWrapper

**文件位置**: `vector_store/vector_store.py`

```python
class VectorStoreWrapper:
    def __init__(self, vector_store: VectorStore)
    def load(self, documents)  # 加载文档到向量存储
    async def asimilarity_search(self, query, k, filter)  # 相似性搜索
```

## 5. 配置接口

### 5.1 Config 类

**文件位置**: `config/config.py`

```python
class Config:
    def __init__(self, config_path: str | None = None)
    
    # 主要配置属性（自动配置）:
    - fast_llm_provider, fast_llm_model: 快速 LLM 设置
    - smart_llm_provider, smart_llm_model: 智能 LLM 设置
    - embedding_provider, embedding_model: 嵌入设置
    - retrievers: 活动检索器列表
    - mcp_strategy: MCP 执行策略
    - 其他配置项...
```

### 5.2 配置加载方法

```python
@classmethod
def load_config(cls, config_path: str | None) -> Dict[str, Any]

def parse_retrievers(self, retriever_str: str) -> List[str]

@staticmethod
def parse_llm(llm_str: str | None) -> tuple[str | None, str | None]

@staticmethod
def parse_embedding(embedding_str: str | None) -> tuple[str | None, str | None]
```

## 6. 多代理系统接口

### 6.1 ChiefEditorAgent 主编辑代理

**文件位置**: `multi_agents/agents/chief_editor_agent.py`

```python
class ChiefEditorAgent:
    def __init__(self, task: dict, websocket=None, stream_output=None, agent=None)
    async def run_research_task(self, report_type: str = "research_report") -> dict
    async def organize_research_task_as_research_outline(self) -> dict
    async def revise_section_content(self, section_content: str, feedback: str) -> str
```

### 6.2 其他代理接口

- **ResearchAgent**: 研究代理
- **WriterAgent**: 写作代理
- **EditorAgent**: 编辑代理
- **PublisherAgent**: 发布代理
- **HumanAgent**: 人类代理（人机交互）
- **ReviewerAgent**: 审核代理
- **ReviserAgent**: 修订代理

## 7. 使用示例

### 7.1 基础使用

```python
from gpt_researcher import GPTResearcher

# 创建研究器实例
researcher = GPTResearcher(
    query="What are the latest developments in AI?",
    report_type="research_report",
    tone="objective"
)

# 执行研究
await researcher.conduct_research()

# 生成报告
report = await researcher.write_report()
print(report)
```

### 7.2 高级使用（带 MCP）

```python
researcher = GPTResearcher(
    query="Latest AI research papers",
    report_type="detailed_report",
    mcp_configs=[{
        "name": "arxiv",
        "command": "python",
        "args": ["mcp_servers/arxiv_server.py"]
    }],
    mcp_strategy="deep"
)
```

### 7.3 Web API 使用

```python
import requests

# 发送研究请求
response = requests.post("http://localhost:8000/report/", json={
    "task": "What is quantum computing?",
    "report_type": "research_report",
    "report_source": "web",
    "tone": "objective"
})

# 获取结果
result = response.json()
print(f"Report generated: {result['file_path']}")
```

### 7.4 CLI 使用

```bash
# 基础查询
python cli.py "What is machine learning?"

# 带参数查询
python cli.py "Latest AI developments" \
  --report_type detailed_report \
  --tone analytical \
  --query_domains arxiv.org,medium.com
```

## 8. 接口关系图

```
用户接口
    ├── CLI (cli.py)
    ├── FastAPI (backend/server/)
    └── 直接导入 (GPTResearcher 类)
            ↓
    GPTResearcher (主协调器)
            ↓
    技能模块
    ├── ResearchConductor (研究执行)
    ├── ReportGenerator (报告生成)
    ├── ContextManager (上下文管理)
    ├── BrowserManager (浏览器管理)
    └── SourceCurator (源管理)
            ↓
    数据检索
    ├── Web 检索器 (Tavily, Google, etc.)
    ├── 学术检索器 (ArXiv, PubMed, etc.)
    └── MCP 检索器 (高级工具)
            ↓
    存储和记忆
    ├── Memory (嵌入管理)
    └── VectorStore (向量存储)
```